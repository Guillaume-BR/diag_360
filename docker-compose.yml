services:
  db:
    image: postgres:${POSTGRES_VERSION:-15}
    container_name: diag360-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ${SHARED_DATA_ROOT:-./docker-data}/postgres:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    networks:
      - diag360-ntw

  backend:
    build:
      context: ./backend
    container_name: diag360-backend
    restart: unless-stopped
    volumes:
      - ./Diag360_EvolV2.xlsx:/data/Diag360_EvolV2.xlsx:ro
    depends_on:
      - db
    environment:
      DATABASE_URL: ${DATABASE_URL}
      BACKEND_PORT: ${BACKEND_PORT}
      ENVIRONMENT: ${ENVIRONMENT:-local}
    expose:
      - "8000"
    networks:
      - diag360-ntw

  backend_ingest:
    build:
      context: ./backend
    container_name: diag360-backend-ingest
    profiles: ["ingest"]
    depends_on:
      - db
    entrypoint: ["python", "-m", "app.cli.ingest_workbook"]
    command: ["--file", "/data/Diag360_EvolV2.xlsx"]
    environment:
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: db
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    volumes:
      - ./backend:/app
      - ./Diag360_EvolV2.xlsx:/data/Diag360_EvolV2.xlsx:ro
    networks:
      - diag360-ntw

  frontend:
    build:
      context: ./front
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    container_name: diag360-frontend
    restart: unless-stopped
    depends_on:
      - backend
    expose:
      - "80"
    networks:
      - diag360-ntw

  nocodb:
    image: nocodb/nocodb:0.205.1
    container_name: diag360-nocodb
    restart: unless-stopped
    environment:
      NC_DB: "pg://db:5432?u=${POSTGRES_USER}&p=${POSTGRES_PASSWORD}&d=${POSTGRES_DB}"
      NC_JWT_SECRET: ${NOCODB_JWT_SECRET}
      NC_PUBLIC_URL: ${NOCODB_PUBLIC_URL}
      NC_ADMIN_EMAIL: ${NOCODB_EMAIL}
      NC_ADMIN_PASSWORD: ${NOCODB_PASSWORD}
      NC_DB_DATABASE: ${POSTGRES_DB}
    depends_on:
      - db
    expose:
      - "${NOCODB_INTERNAL_PORT:-8080}"
    networks:
      - diag360-ntw

networks:
  diag360-ntw:
    external: true
